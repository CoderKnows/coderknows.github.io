---
layout: post
title:  "Jekyll 3: Комментарии"
author: vdovenko_eugene
date:   2019-06-04 12:38:00 +0000
tags:   [Jekyll, статический сайт, CMS, Disqus]
categories: [Jekyll]
---

Для комментирования используются сторонние сервисы. 

Первое, что я попробовал был сервис [Staticman](https://staticman.net/). Этот сервис 
делает каждый комментарий отдельным `merge request`-ом в репозиторий сайта. Подключить его 
не получилось, так как на текущий момент сервис очень загружен и автивировать сервис для 
сайта не удалось. Есть вариант установить сервис на свой сервер (self-hosted вариант), 
только какой смысл иметь статический сайт и хостить к нему динамические компоненты?

Самый популярный сервис комментирования - [Disqus](https://disqus.com/). Все комментарии 
хранятся на сервисе и доступны в рамках сообществ. При подключении к сайту можно отображать 
все комментарии вперемешку, либо к коментариям каждой статьи передавать уникальный ключ и 
отображать к каждой статье свои комментарии. Из минусов данного сервиса: 
- сервис собирает данные пользователей,
- увеличивается размер загружаемых страниц из-за подключаемых скриптов 
- это создает дополнительную нагрузку на браузер и интернет-канал пользователя. 

Но сервис работает стабильно, что в некотором смысле компенсирует неудобства.

### Установка

После регистрации в сервисе нужно подключить новый сайт. Сервис выделит новый поддомен, вида
`subdomain.disqus.com`.

Далее, в шаблон статьи добавляем снипет:
```
<div id="disqus_thread"></div>
<script>
  var disqus_shortname = 'subdomain';
  var disqus_config = function () {
    this.page.url = "{{ page.url | prepend: site.url }}";
    this.page.identifier = "{{ page.id }}";
  };

  (function() {  // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');

    s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
```

И теперь, в конце каждой статьи будет отображаться блок с комментариями.

### Дополнительные настройки

#### Отображение комментариев

В разделе front matter шаблона статьи задаем переменную:
```
comments: false
```
и оборачиваем сниппет подключения комментариев в блок с условием:
```
...
\{\% if page.comments != false \%\}
  ...
\{\% endif \%\}
...
``` 

Если переменная comments равна false - блок с комментариями подключаться не будет.

#### Счетчик комментариев

В шаблоне со списком статей можно отображать количество комментариев. Для этого добавляем 
для каждой статьи ссылку вида:
```
<a href="{{ post.url }}#disqus_thread" class="disqus-comment-count" data-disqus-identifier="{{ post.id }}"></a>
```

- `#disqus_thread` - это якорь, который перекинет пользователя скару в конец статьи к блоку комментариев.
- `class="disqus-comment-count"` - по этому классу подключаемый js-скрипт заменяет содержимое тега на текст 
  вида `99 Comments`
- `data-disqus-identifier="{{ post.id }}"` - уникальный идентификатор, который позволяет отделить комментарии 
  для выделенной статьи от всех комментариев. Этот параметр задается в сниппете подключения сервиса.

и подключаем скрипт:
```
<script id="dsq-count-scr" src="//subdomain.disqus.com/count.js" async></script>
```

__NB!__ Всё это в шаблоне со списком статей.

Можно использовать переменную `post.comments`, чтобы  подключать скрипт или отображать счетчик для
статей с включенными комментариями.


__Полезные ссылки__:
1. [Официальная документация](https://jekyllrb.com/docs/) (en)
1. [Add commenting to your posts and other pages using Disqus](https://learn.cloudcannon.com/jekyll/using-diqus-for-comments/) (en)
